!function(e){function t(i){if(n[i])return n[i].exports;var a=n[i]={exports:{},id:i,loaded:!1};return e[i].call(a.exports,a,a.exports,t),a.loaded=!0,a.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function a(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}var r=n(1),c=i(r),s=io(),o=c["default"].$(".input"),d=c["default"].$(".send"),l=c["default"].$(".message ul"),u=c["default"].$(".inputname"),f=c["default"].$(".confirm"),p=c["default"].$("#shade"),m=c["default"].$(".userlist"),g=c["default"].$(".users .nums"),v=c["default"].$(".upload"),h=c["default"].$(".upload-form"),y=c["default"].$(".send-img"),$=c["default"].$(".heart"),C=c["default"].$(".heart-dialog"),N=JSON.parse(localStorage.getItem("pics")||0)||[],x=c["default"].$(".pics-box"),L=c["default"].$(".heart-pics"),E=(c["default"].$(".myself-info .head"),c["default"].$(".myself-info .name")),k="hall";u.focus();var S=function(e){[].concat(a(e)).forEach(function(e){var t=c["default"].$c("div",{className:"heart-item"}),n=c["default"].$c("img",{className:"heart-img",src:e}),i=c["default"].$c("div",{className:"del-img",innerHTML:"×",title:"删除"});i.pic=e,t.appendChild(i),t.appendChild(n),x.appendChild(t)})},T=function(e,t){var n=c["default"].$c("li",{className:"chatitem "+(t?"myself":"others")}),i=c["default"].$c("span",{className:"time",textContent:"("+c["default"].timeformat(e.time)+")"}),a=c["default"].$c("p",{className:"username"}),r=document.createTextNode(e.username+(t?"-我":""));t?(a.appendChild(i),a.appendChild(r)):(a.appendChild(r),a.appendChild(i)),c["default"].decompress(e.msg,function(e){var t=c["default"].$c("p",{className:"msg",innerHTML:e});n.appendChild(a),n.appendChild(t),l.appendChild(n),n.scrollIntoView(!1)})},w=function(e,t){m.innerHTML="";var e=s.id;t.forEach(function(t){var n=c["default"].$c("li",{id:"id"+t.id,className:"user-item",textContent:t.username+(t.id===e?"(我)":"")});m.appendChild(n)})},A=function(e,t,n){var i=s.id===t;if(i)p.style.display="none",E.textContent=e,o.focus();else if(!s.isLogin)return;w(t,n),g.textContent=n.length,O(e+" 加入群聊","userjoin")},M=function(e,t,n){var i=c["default"].$("#id"+e);i.parentNode.removeChild(i),g.textContent=n,O(t+"退出群聊","userout")},O=function(e,t){var n=c["default"].$c("li",{className:"chatitem msgitem "+t,innerHTML:'<p class="msgcontent">'+e+"</p>"});l.appendChild(n),n.scrollIntoView()},R=function I(e){I.wait=1500,clearTimeout(I[e]);var t=c["default"].$("#id"+e);t.querySelector(".inputing")||t.appendChild(c["default"].$c("span",{className:"inputing",textContent:"（正在输入……）"})),I[e]=setTimeout(function(){var e=t.querySelector(".inputing");clearTimeout(I.st),e.parentNode.removeChild(e)},I.wait)},b=function(e){u.classList.add("conflict"),u.setAttribute("placeholder","昵称"+e+"已被占用"),u.value="",p.style.display="",u.focus()},D=function(e,t){var n=document.createRange(),i=window.getSelection(),r=i.anchorNode;if(r&&(r===o||r.parentNode===o)){var s=i.anchorOffset,d=i.focusOffset,l=0,u=0;if(r===o){var f="text"===t?document.createTextNode(e):c["default"].$c("img",{className:"pic",src:e});r.insertBefore(f,r.childNodes[s]),u=s+1}else if("text"===t){var p=r.textContent;r.textContent=p.slice(0,s+l)+e+p.slice(d+l),u=s+e.length}else!function(){var t=c["default"].$c("img",{className:"pic",src:e}),n=document.createTextNode(r.textContent.slice(0,s)),i=document.createTextNode(r.textContent.slice(d)),l=document.createDocumentFragment();l.appendChild(n),l.appendChild(t),l.appendChild(i),r.parentNode.replaceChild(l,r),u=[].concat(a(o.childNodes)).findIndex(function(e){return e===t})+1,r=o}();n.setStart(r,u),i.removeAllRanges(),i.addRange(n)}},H=function(e,t){if(e&&/^image\/[a-z]+$/.test(e.type)){if(e.size<=0)return;var n=100;if(e.size>1024*n)return void O("图片不得超过"+n+"k","warning");var i=new FileReader;i.onload=function(e){t?D(e.target.result):j(e.target.result)},i.readAsDataURL(e)}},j=function(e){var t=document.createRange(),n=window.getSelection();o.innerHTML+=/^data:image\/[a-z]+;base64/.test(e)?"<img class='pic' src="+e+">":e,t.setStart(o,o.childNodes.length),n.removeAllRanges(),n.addRange(t)};s.on("connect",function(){f.addEventListener("click",function(){var e=u.value.replace(/\s/g,"");e?s.emit("join",e,s.id):u.focus()}),u.addEventListener("keydown",function(e){13==e.keyCode&&f.click()}),s.on("conflict"+s.id,b),s.on("userjoin",function(e,t,n){A(e,t,n),s.id===t&&(s.isLogin=!0,S(N),s.on("userout",M),s.on("inputing",R),d.addEventListener("click",function(e){var t=o.innerHTML.trim();t&&c["default"].compress(t,function(e){s.emit("hall"==k?"chat":"private",e),o.innerHTML=""})}),o.addEventListener("input",function(e){var t=this;this.isinputing||(this.isinputing=!0,s.emit("inputing"),this.st=setTimeout(function(){clearTimeout(t.st),t.isinputing=!1},1200))}),o.addEventListener("keydown",function(e){13!=e.keyCode||e.ctrlKey||(d.click(),e.preventDefault())}),o.addEventListener("drop",function(e){var t=e.dataTransfer;[].concat(a(t.items)).forEach(function(e){var t=e.type;t.match(/^image\//)?H(e.getAsFile()):"text/plain"===t&&e.getAsString(j)}),e.preventDefault()}),o.addEventListener("paste",function(e){var t=e.clipboardData;[].concat(a(t.items)).forEach(function(e){var t=e.type;t.match(/^image\//)?H(e.getAsFile(),!0):"text/plain"===t&&e.getAsString(function(e){D(e,"text")})}),e.preventDefault()}),y.addEventListener("click",function(e){v.click()}),s.on("chat",function(e){T(e,e.id===s.id)}),s.on("private",function(e){T(e,e.id===s.id)}),v.addEventListener("change",function(e){var t=this.files[0];t&&(/^image\/[a-z]+$/.test(t.type)?H(this.files[0]):O("请选择图片","warning"),h.reset())}),document.addEventListener("contextmenu",function(e){"pic"===e.target.className&&(Object.assign(C.style,{top:e.pageY+"px",left:e.pageX+"px",display:"block"}),C.pic=e.target.src,e.preventDefault())}),C.addEventListener("click",function(e){var t=this;N.find(function(e){return e==t.pic})?O("该图已收藏","warning"):(N.push(this.pic),S([this.pic]),localStorage.setItem("pics",JSON.stringify(N))),this.style.display="none"}),$.addEventListener("click",function(e){this.open?L.style.display="none":L.style.display="block",this.open=!this.open}),x.addEventListener("click",function(e){var t=e.target;if(/^heart-img$|^heart-item$/.test(t.className)){var n="heart-item"===t.className?t.childNodes[0].src:t.src;j(n),$.open=!1,L.style.display="none"}else if("del-img"===t.className){var i=N.findIndex(function(e){return e===t.pic});x.removeChild(x.childNodes[i]),N.splice(i,1),localStorage.setItem("pics",JSON.stringify(N))}}),document.addEventListener("click",function(e){var t=L.getBoundingClientRect(),n=$.getBoundingClientRect(),i=C.getBoundingClientRect(),a=e.pageX,r=e.pageY;c["default"].isOutside(a,r,t)&&c["default"].isOutside(a,r,n)&&($.open=!1,L.style.display="none"),c["default"].isOutside(a,r,i)&&(C.style.display="none")}),m.addEventListener("click",function(e){if("user-item"===e.target.className){k=e.target.id;var t=e.target.dataset.room;k||s.emit("startprivate",{id:k.slice(2),room:t})}}),s.on("joinroom",function(e){var t=e.id.find(function(e){return e!=s.id});c["default"].$("#id"+t).dataset.room=e.room}),s.on("private",function(e){T(e.msg,e.id===s.id)}))})})},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t["default"]={$:function(e){return document.querySelector(e)},$$:function(e){return document.querySelectorAll(e)},$c:function(e,t){var n=document.createElement(e);return Object.assign(n,t),n},timeformat:function(e){var t=new Date(e),n=t.getMonth()+1,i=t.getDate(),a=t.getHours(),r=t.getMinutes(),c=t.getSeconds();return n=n>9?n:"0"+n,i=i>9?i:"0"+i,a=a>9?a:"0"+a,r=r>9?r:"0"+r,c=c>9?c:"0"+c,n+"-"+i+" "+a+":"+r+":"+c},isOutside:function(e,t,n){return e<n.left||e>n.right||t>n.bottom||t<n.top},compress:function(e,t){LZMA.compress(e,1,function(n,i){t(i?e:n)})},decompress:function(e,t){LZMA.decompress(e,function(n,i){t(i?e:n)})}}}]);